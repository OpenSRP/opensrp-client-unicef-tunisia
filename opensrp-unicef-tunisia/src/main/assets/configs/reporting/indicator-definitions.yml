indicators:
  - key: "at_birth_vaccines"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received particular vaccines"
    indicatorQuery: "SELECT vaccines.name,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) <= 1 THEN '0_24hrs'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= 2 AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= 59 THEN '2_59days'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END age,
                            count(*)
                     FROM vaccines
                              INNER JOIN ec_client
                                         ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY vaccines.name, age"
    expectedIndicators:
      - "at_birth_vaccines_bcg"
      - "at_birth_vaccines_bcg_2_59days"
      - "at_birth_vaccines_hep_b_0_0_24hrs"
      - "at_birth_vaccines_hep_b_0_2_59days"
      - "at_birth_vaccines_pcv_2_2_6mnths"
      - "at_birth_vaccines_pcv_2_7_11mnths"
      - "at_birth_vaccines_pcv_2_12_17mnths"
      - "at_birth_vaccines_pcv_2_18_23mnths"
      - "at_birth_vaccines_pcv_2_24_59mnths"
      - "at_birth_vaccines_pcv_3_7_11mnths"
      - "at_birth_vaccines_pcv_3_12_17mnths"
      - "at_birth_vaccines_pcv_3_18_23mnths"
      - "at_birth_vaccines_pcv_3_24_59mnths"
      - "at_birth_vaccines_mr_1_12_17mnths"
      - "at_birth_vaccines_mr_1_18_23mnths"
      - "at_birth_vaccines_mr_1_24_59mnths"
      - "at_birth_vaccines_mr_2_18_23mnths"
      - "at_birth_vaccines_mr_2_24_59mnths"
      - "at_birth_vaccines_dtp_4_18_23mnths"
      - "at_birth_vaccines_dtp_4_24_59mnths"

  - key: "penta1_grp"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received ipv_1, pcv_1 and penta_1 vaccines"
    indicatorQuery: "SELECT 'penta1'                                                                                         as penta1,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END                                                                                             age,
                            (SELECT count(base_entity_id)
                             FROM (SELECT DISTINCT vaccines.base_entity_id
                                   FROM vaccines
                                            INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                   WHERE ec_client.is_closed != 1
                                     AND (vaccines.name = 'ipv_1' OR vaccines.name = 'penta_1' OR vaccines.name = 'pcv_1')
                                     AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))) as count
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY age"
    expectedIndicators:
      - "penta1_grp_penta1_2_6mnths"
      - "penta1_grp_penta1_7_11mnths"
      - "penta1_grp_penta1_12_17mnths"
      - "penta1_grp_penta1_18_23mnths"
      - "penta1_grp_penta1_24_59mnths"

  - key: "penta2_grp"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received ipv_2 and penta_2 vaccines"
    indicatorQuery: "SELECT 'penta2'                                                                                         as penta2,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END                                                                                             age,
                            (SELECT count(base_entity_id)
                             FROM (SELECT DISTINCT vaccines.base_entity_id
                                   FROM vaccines
                                            INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                   WHERE ec_client.is_closed != 1
                                     AND (vaccines.name = 'ipv_2' OR vaccines.name = 'penta_2')
                                     AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))) as count
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY age;"
    expectedIndicators:
      - "penta2_grp_penta2_2_6mnths"
      - "penta2_grp_penta2_7_11mnths"
      - "penta2_grp_penta2_12_17mnths"
      - "penta2_grp_penta2_18_23mnths"
      - "penta2_grp_penta2_24_59mnths"

  - key: "penta3_grp"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received ipv_1 and penta_3 vaccines"
    indicatorQuery: "SELECT 'penta3'                                                                                         as penta3,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END                                                                                             age,
                            (SELECT count(base_entity_id)
                             FROM (SELECT DISTINCT vaccines.base_entity_id
                                   FROM vaccines
                                            INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                   WHERE ec_client.is_closed != 1
                                     AND (vaccines.name = 'opv_1' OR vaccines.name = 'penta_3')
                                     AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))) as count
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY age;"
    expectedIndicators:
      - "penta3_grp_penta3_2_6mnths"
      - "penta3_grp_penta3_7_11mnths"
      - "penta3_grp_penta3_12_17mnths"
      - "penta3_grp_penta3_18_23mnths"
      - "penta3_grp_penta3_24_59mnths"

  - key: "bcg_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received BCG vaccine at the facility"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'bcg'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "hepb_0_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Hep B 0 vaccine at the facility"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'hep_b_0'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "penta1_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Penta1, IPV1 and PCV1 vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM ec_client
                                    INNER JOIN vaccines ON ec_client.base_entity_id = vaccines.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND (vaccines.name = 'ipv_1' OR vaccines.name = 'penta_1' OR vaccines.name = 'pcv_1')
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))
"

  - key: "penta2_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Penta2 and IPV2 vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM ec_client
                                    INNER JOIN vaccines ON ec_client.base_entity_id = vaccines.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND (vaccines.name = 'penta_2' OR vaccines.name = 'ipv_2')
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "pcv2_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  PCV2  vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'pcv_2'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "penta3_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Penta 3 and OPV1  vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM ec_client
                                    INNER JOIN vaccines ON ec_client.base_entity_id = vaccines.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND (vaccines.name = 'penta_3' OR vaccines.name = 'opv_1')
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "pcv3_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  PCV3 vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'pcv_3'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "mr1_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  MR1vaccine"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'mr_1'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "mr2_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  MR2 vaccine"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'mr_2'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "dtp4_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received DTP4 vaccine"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'dtp_4'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "vaccine_doses_administered"
    isMultiResult: true
    grouping: "report_group_header_vaccine_utilization"
    description: "Number of doses administered for each vaccine BCG,  OPV,  DTP,  MR,  Hep B,  Penta,  IPV, PCV, Rubella"
    indicatorQuery: "SELECT 'vaccine' as vaccine,
                            vaccines.name,
                            count(*)
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     group by vaccines.name;"
    expectedIndicators:
      - "vaccine_doses_administered_vaccine_bcg"
      - "vaccine_doses_administered_vaccine_hep_b_0"
      - "vaccine_doses_administered_vaccine_opv_1"
      - "vaccine_doses_administered_vaccine_opv_2"
      - "vaccine_doses_administered_vaccine_dtp_4"
      - "vaccine_doses_administered_vaccine_mr_1"
      - "vaccine_doses_administered_vaccine_mr_2"
      - "vaccine_doses_administered_vaccine_penta_1"
      - "vaccine_doses_administered_vaccine_penta_2"
      - "vaccine_doses_administered_vaccine_penta_3"
      - "vaccine_doses_administered_vaccine_pcv_1"
      - "vaccine_doses_administered_vaccine_pcv_2"
      - "vaccine_doses_administered_vaccine_pcv_3"
      - "vaccine_doses_administered_vaccine_pcv_4"
      - "vaccine_doses_administered_vaccine_ipv_1"
      - "vaccine_doses_administered_vaccine_ipv_2"

  - key: "vaccine_doses_administered_rubella"
    grouping: "report_group_header_vaccine_utilization"
    description: "Number of doses administered for each vaccine BCG,  OPV,  DTP,  MR,  Hep B,  Penta,  IPV, PCV, Rubella"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT base_entity_id
                           FROM (SELECT DISTINCT ec_child_details.base_entity_id
                                 FROM ec_child_details
                                          INNER JOIN ec_mother_details
                                                     ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                                 WHERE ec_child_details.date_removed IS NULL
                                   AND ec_mother_details.mother_rubella = 'yes' COLLATE NOCASE
                                   AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                                ));"

  - key: "pab_mother_dt"
    grouping: "report_group_header_tetanus_protected"
    description: "Month to month visual of the number of  children that are protected against tetanus at birth, through the tetanus vaccine received by the mother during pregnancy (mother dT) only."
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                                       INNER JOIN ec_mother_details
                                                  ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                              WHERE ec_child_details.date_removed IS NULL
                                AND ec_mother_details.protected_at_birth = 'yes' COLLATE NOCASE
                                AND ec_child_details.place_of_birth IS NOT 'hospital' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          )"

  - key: "pab_assisted_delivery"
    grouping: "report_group_header_tetanus_protected"
    description: "Month to month visual of the number of  children that are protected against tetanus through assisted delivery only "
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                                       INNER JOIN ec_mother_details
                                                  ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                              WHERE ec_child_details.date_removed IS NULL
                                AND ec_mother_details.protected_at_birth = 'no' COLLATE NOCASE
                                AND ec_child_details.place_of_birth IS 'hospital' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          )"

  - key: "pab_dt_and_assisted_delivery"
    grouping: "report_group_header_tetanus_protected"
    description: "Month to month visual of the number of  children that are protected against tetanus at birth, through the tetanus vaccine received by the mother during pregnancy (mother dT) and assisted delivery"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                                       INNER JOIN ec_mother_details
                                                  ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                              WHERE ec_child_details.date_removed IS NULL
                                AND ec_mother_details.protected_at_birth = 'yes' COLLATE NOCASE
                                AND ec_child_details.place_of_birth IS 'hospital' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          )"

  - key: "total_child_births"
    grouping: "report_group_header_rubella_vaccine"
    description: "Number of total births in the facility"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                              WHERE ec_child_details.is_closed != '1'
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                          );"

  - key: "number_first_birth"
    grouping: "report_group_header_rubella_vaccine"
    description: "Number of women giving birth for the first time in this month"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_mother_details.base_entity_id
                              FROM ec_mother_details
                              WHERE ec_mother_details.date_removed IS NULL
                                AND ec_mother_details.first_birth = 'yes' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          );"

  - key: "number_rubella_serology"
    grouping: "report_group_header_rubella_vaccine"
    description: "Number of primapara women who got a Rubella serology test in the facility this month"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_mother_details.base_entity_id
                              FROM ec_mother_details
                              WHERE ec_mother_details.date_removed IS NULL
                                AND ec_mother_details.first_birth = 'yes' COLLATE NOCASE
                                AND ec_mother_details.rubella_serology = 'yes' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          );"

  - key: "negative_serology_results"
    grouping: "report_group_header_rubella_vaccine"
    description: "Number of primapara women that got a serology test with negative results"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_mother_details.base_entity_id
                              FROM ec_mother_details
                              WHERE ec_mother_details.date_removed IS NULL
                                AND ec_mother_details.first_birth = 'yes' COLLATE NOCASE
                                AND ec_mother_details.rubella_serology = 'yes' COLLATE NOCASE
                                AND ec_mother_details.serology_results = 'negative' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          );"

  - key: "women_vaccinated_rubella"
    grouping: "report_group_header_rubella_vaccine"
    description: "Number of women who had a negative serology test that were vaccinated against Rubella ({mother_rubella} =''yes''"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_mother_details.base_entity_id
                              FROM ec_mother_details
                              WHERE ec_mother_details.date_removed IS NULL
                                AND ec_mother_details.mother_rubella = 'yes' COLLATE NOCASE
                                AND ec_mother_details.first_birth = 'yes' COLLATE NOCASE
                                AND ec_mother_details.rubella_serology = 'yes' COLLATE NOCASE
                                AND ec_mother_details.serology_results = 'negative' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          );"

  - key: "right_measures_6months"
    grouping: "report_group_header_adequate_growth_measurement"
    description: "number of children age 6 months with at least 3 measurements on the curve"
    indicatorQuery: "SELECT count(ec_child_details.base_entity_id)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                           ) >= 4
                       AND strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)"

  - key: "right_measures_12months"
    grouping: "report_group_header_adequate_growth_measurement"
    description: "number of children age 12 months with at least 4 measurements on the curve"
    indicatorQuery: "SELECT count(ec_child_details.base_entity_id)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                           ) >= 5
                       AND strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)"

  - key: "right_measures_18months"
    grouping: "report_group_header_adequate_growth_measurement"
    description: "number of children age 18 months with at least 5 measurements on the curve"
    indicatorQuery: "SELECT count(ec_child_details.base_entity_id)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                           ) >= 6
                       AND strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)"

  - key: "measures_grp"
    isMultiResult: true
    grouping: "report_group_header_adequate_growth_measurement"
    description: "Count children who are 6, 12 and 18 months respectively"
    indicatorQuery: "SELECT 'children' as children,
                            CASE
                                WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                ELSE 'Null'
                                END       age,
                            count(*)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') =  strftime('%Y-%m-%d', ec_child_details.event_date)
                     GROUP BY age;"
    expectedIndicators:
      - "measures_grp_children_6mnths"
      - "measures_grp_children_12mnths"
      - "measures_grp_children_18mnths"

  - key: "malnutrition_episode_6months"
    grouping: "report_group_header_previous_under_nutrition"
    description: "Number of children 6 months of age with at least 1 ‘previous episode of weight-for-age z-score of -2 or below ( undernutrition) "
    indicatorQuery: "SELECT count(ec_child_details.base_entity_id)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                 AND weights.z_score <= -2
                           ) >= 1
                       AND strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)"

  - key: "malnutrition_episode_12months"
    grouping: "report_group_header_previous_under_nutrition"
    description: "Number of children with at least 1 ‘previous episode of undernutrition (moderate or severe malnutrition) at 12 months."
    indicatorQuery: "SELECT count(ec_child_details.base_entity_id)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                 AND weights.z_score <= -2
                           ) >= 1
                       AND strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)"

  - key: "malnutrition_episode_18months"
    grouping: "report_group_header_previous_under_nutrition"
    description: "Number of children with at least 1 ‘previous episode of undernutrition (moderate or severe malnutrition) at 18 months."
    indicatorQuery: "SELECT count(ec_child_details.base_entity_id)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                 AND weights.z_score <= -2
                           ) >= 1
                       AND strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)"

  - key: "malnutrition_episode_percent_grp"
    isMultiResult: true
    grouping: "report_group_header_adequate_growth_measurement"
    description: "Count children who are 6, 12 and 18 months respectively"
    indicatorQuery: "SELECT 'children' as children,
                            CASE
                                WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                ELSE 'Null'
                                END       age,
                            count(*)
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                       AND (
                               SELECT count(weights.base_entity_id)
                               FROM weights
                               WHERE weights.base_entity_id = ec_child_details.base_entity_id
                           ) >= 2"
    expectedIndicators:
      - "malnutrition_episode_percent_grp_children_6mnths"
      - "malnutrition_episode_percent_grp_children_12mnths"
      - "malnutrition_episode_percent_grp_children_18mnths"

  - key: "mid_mal_grp"
    isMultiResult: true
    grouping: "report_group_header_diagnosed_malnourished"
    description: "number of children with mild malnutrition at 6,12 and 18 months"
    indicatorQuery: "SELECT 'children' as children,
                            CASE
                                WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                ELSE 'Null'
                                END       age,
                            (
                                SELECT count(weights.base_entity_id)
                                FROM weights
                                WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                  AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                                  AND weights.z_score > -2
                                  AND weights.z_score <= 1
                            )          as count
                     FROM ec_child_details
                              INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                     WHERE ec_child_details.is_closed != 1
                     GROUP BY age;"
    expectedIndicators:
      - "mid_mal_grp_children_6mnths"
      - "mid_mal_grp_children_12mnths"
      - "mid_mal_grp_children_18mnths"

  - key: "mod_mal_grp"
    isMultiResult: true
    grouping: "report_group_header_diagnosed_malnourished"
    description: "number of children with moderate malnutrition at 6,12 and 18 months"
    indicatorQuery: "SELECT 'children' as children,
                              CASE
                                  WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                  WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                  WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                  ELSE 'Null'
                                  END       age,
                              (
                                  SELECT count(weights.base_entity_id)
                                  FROM weights
                                  WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                    AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                                    AND weights.z_score > -3
                                    AND weights.z_score <= -2
                              )          as count
                       FROM ec_child_details
                                INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                       WHERE ec_child_details.is_closed != 1
                       GROUP BY age;"
    expectedIndicators:
      - "mod_mal_grp_children_6mnths"
      - "mod_mal_grp_children_12mnths"
      - "mod_mal_grp_children_18mnths"

  - key: "sev_mal_grp"
    isMultiResult: true
    grouping: "report_group_header_diagnosed_malnourished"
    description: "number of children with severe malnutrition at 6,12 and 18 months"
    indicatorQuery: "SELECT 'children' as children,
                                CASE
                                    WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                    WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                    WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                    ELSE 'Null'
                                    END       age,
                                (
                                    SELECT count(weights.base_entity_id)
                                    FROM weights
                                    WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                      AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                                      AND weights.z_score <= -3
                                )          as count
                         FROM ec_child_details
                                  INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                         WHERE ec_child_details.is_closed != 1
                         GROUP BY age;"
    expectedIndicators:
      - "sev_mal_grp_children_6mnths"
      - "sev_mal_grp_children_12mnths"
      - "sev_mal_grp_children_18mnths"

  - key: "obese_grp"
    isMultiResult: true
    grouping: "report_group_header_diagnosed_malnourished"
    description: "number of children who are obese at 6,12 and 18 months"
    indicatorQuery: "SELECT 'children' as children,
                                CASE
                                    WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                    WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                    WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                    ELSE 'Null'
                                    END       age,
                                (
                                    SELECT count(weights.base_entity_id)
                                    FROM weights
                                    WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                      AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                                      AND weights.z_score >= 2
                                )          as count
                         FROM ec_child_details
                                  INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                         WHERE ec_child_details.is_closed != 1
                         GROUP BY age;"
    expectedIndicators:
      - "obese_grp_children_6mnths"
      - "obese_grp_children_12mnths"
      - "obese_grp_children_18mnths"

  - key: "weight_height_count_grp"
    isMultiResult: true
    grouping: "report_group_header_diagnosed_malnourished"
    description: "number of children with weight and height recorded at 6,12 and 18 months"
    indicatorQuery: "SELECT 'children' as children,
                              CASE
                                  WHEN strftime('%Y%m', date(ec_client.dob, '+6 month')) - strftime('%Y%m', date('now')) = 0 THEN '6mnths'
                                  WHEN strftime('%Y%m', date(ec_client.dob, '+12 month')) - strftime('%Y%m', date('now')) = 0 THEN '12mnths'
                                  WHEN strftime('%Y%m', date(ec_client.dob, '+18 month')) - strftime('%Y%m', date('now')) = 0 THEN '18mnths'
                                  ELSE 'Null'
                                  END       age,
                              (
                                  SELECT count(weights.base_entity_id)
                                  FROM weights
                                  WHERE weights.base_entity_id = ec_child_details.base_entity_id
                                  AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_child_details.event_date)
                              )          as count
                       FROM ec_child_details
                                INNER JOIN ec_client ON ec_client.base_entity_id = ec_child_details.base_entity_id
                       WHERE ec_child_details.is_closed != 1
                       GROUP BY age;"
    expectedIndicators:
      - "weight_height_count_grp_children_6mnths"
      - "weight_height_count_grp_children_12mnths"
      - "weight_height_count_grp_children_18mnths"